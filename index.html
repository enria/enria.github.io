<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>enria blog</title>
    <script src="plugin/jquery.js"></script>
    <script src="plugin/vue.js"></script>
    <script src="plugin/marked.js"></script>
    <script src="plugin/bootstrap/js/bootstrap.js"></script>
    <script src="plugin/jquery.svg.pan.zoom.js"></script>
    <script src="https://cdn.bootcss.com/jquery-loading-overlay/2.1.3/loadingoverlay.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/base64.js"></script>
    <link type="text/css" rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">
</head>

<body>
    <div class="layout" style="height: 100%;">
        <div id="side" :style="{width:layout.menu_width_percent+'%'}">
            <div id="side-type">
                <div class="tab" :class="{active:layout.side_type=='tree'}">Tree</div>
                <div class="tab">Outline</div>
            </div>
            <template v-if="layout.side_type=='tree'">
                <tp-menu id="menu" :folder="menu.blogs" @choose-blog="content.blog=$event"></tp-menu>
            </template>
        </div>
        <div id="content" :style="{width:(100-layout.menu_width_percent)+'%'}">
            <tp-content :blog="content.blog"></tp-content>
        </div>
    </div>
</body>
<script src="js/markdown-directive.js"></script>
<script>
    $(document).ready(function () {
        Vue.component("tp-folder", {
            props: ["folder", "name", "prop_display"],
            data: function () {
                return {
                    display: !!this.prop_display
                }
            },
            template: `
                    <div>
                        <span v-if="name" @click="display=!display"> <i class="fas fa-folder"></i>{{name}}</span>
                        <ul v-show="display">
                            <li v-for="(value,key) in folder">
                                <template v-if="!value.type">
                                    <tp-folder :folder="value" :name="key" @choose-blog="$emit('choose-blog',$event)"></tp-folder>
                                </template>
                                <template v-if="value.type=='blob'" >
                                    <span @click="$emit('choose-blog',value)"><i class="fas fa-file-alt"></i>&nbsp;{{key}}</span>
                                </template>
                            </li>
                        </ul>
                    </div>`
        })
        Vue.component('tp-menu', {
            props: ['folder'],
            data: function () {
                return {}
            },
            template: `<div style="margin-left:-15px;"><tp-folder :folder="folder" :prop_display="true" @choose-blog="$emit('choose-blog',$event)"></tp-folder></div>`
        });
        Vue.component('tp-content', {
            props: ['width', 'blog'],
            data: function () {
                return {
                    content: ""
                }
            },
            watch: {
                blog: function (val) {
                    var vm = this
                    $.LoadingOverlay("show")
                    $.getJSON(val.url, function (data) {
                        if (val.type == "blob") {
                            vm.content = new Base64().decode(data.content)
                        } else {
                            vm.content = data
                        }
                        $.LoadingOverlay("hide")
                    })
                }
            },
            methods: {
            },
            template: `
                <div id="markdown-html" v-markdown="content"></div>`
        });
        var layout_vm = new Vue({
            el: ".layout",
            data: {
                layout: {
                    menu_width_percent: LAYOUT.init_menu_width_percent,
                    side_type:'tree'
                },
                theme: {
                    themes: ["vue"],
                    current: null
                },
                menu: {
                    blogs: []
                },
                content: {
                    blog: null
                }
            },
            watch: {
                "theme.current": function (val) {
                    var head = document.getElementsByTagName('head')[0];
                    var link = document.createElement('link');
                    link.type = 'text/css';
                    link.rel = 'stylesheet';
                    link.href = "theme/" + val + ".css";
                    head.appendChild(link);
                }
            },
            methods: {
                init_theme: function () {
                    this.theme.current = "vue"
                },
                init_tree: function () {
                    var vm = this
                    this.get_tree(null, function (tree) {
                        vm.menu.blogs = tree
                    })
                },
                get_tree: function (root, callback) {
                    if (!root) {
                        root = "/"
                    }
                    $.getJSON(GITHUB_API.url.tree, function (result) {
                        var root = {}
                        $.each(result.tree, function (i, blog) {
                            var path = blog.path.split('/')
                            var current = root
                            $.each(path, function (d, folder) {
                                if (d >= path.length - 1) {
                                    if (blog.type == "blob") {
                                        current[folder] = blog
                                    } else {
                                        $.extend(current[folder], blog)
                                    }
                                } else {
                                    if (current[folder]) {
                                        current = current[folder]
                                    } else {
                                        var pass = current
                                        current = {}
                                        pass[folder] = current
                                    }
                                }
                            })
                        })
                        console.log(root)
                        callback(root)
                    })
                }
            }
        })

        layout_vm.init_tree()
        layout_vm.init_theme()
    })
    var a
</script>

</html>